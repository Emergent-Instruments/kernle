---
title: Subscriptions API
description: "API endpoints for managing Kernle cloud subscriptions and payments"
---

# Subscriptions API

The Subscriptions API enables fully autonomous subscription management with USDC payments on Base L2.

## Authentication

All subscription endpoints require a valid API key in the `Authorization` header:

```bash
Authorization: Bearer knl_xxxxxxxxxxxx
```

Get your API key with `kernle auth register` or `kernle auth status`.

## Endpoints

### POST /api/v1/subscriptions/upgrade

Initiate a tier upgrade. This creates a payment intent and returns the treasury address for USDC payment.

<AccordionGroup>
  <Accordion title="Request Body">
    ```json
    {
      "tier": "core"  // "core", "pro", or "enterprise"
    }
    ```
  </Accordion>
  
  <Accordion title="Response">
    ```json
    {
      "payment_intent": {
        "id": "pi_abc123",
        "amount": "5.000000",
        "currency": "USDC",
        "chain": "base",
        "treasury_address": "0xKernleTreasury...",
        "from_wallet": "0xAb3...7eF",
        "deadline": "2026-02-01T15:30:00Z"
      },
      "tier": {
        "name": "core",
        "price": "5.000000",
        "storage_limit": 104857600,  // 100MB
        "stack_limit": 3,
        "features": ["auto_sync", "unlimited_frequency"]
      }
    }
    ```
  </Accordion>
  
  <Accordion title="Example">
    ```bash
    curl -X POST https://api.kernle.ai/v1/subscriptions/upgrade \
      -H "Authorization: Bearer knl_xxxxxxxxxxxx" \
      -H "Content-Type: application/json" \
      -d '{"tier": "core"}'
    ```
  </Accordion>
</AccordionGroup>

### POST /api/v1/subscriptions/confirm

Confirm payment and activate the new tier. Call this after sending USDC to the treasury address.

<AccordionGroup>
  <Accordion title="Request Body">
    ```json
    {
      "payment_intent_id": "pi_abc123",
      "tx_hash": "0x..."  // Transaction hash of USDC payment
    }
    ```
  </Accordion>
  
  <Accordion title="Response">
    ```json
    {
      "subscription": {
        "id": "sub_def456",
        "tier": "core",
        "status": "active",
        "starts_at": "2026-02-01T00:00:00Z",
        "renews_at": "2026-03-01T00:00:00Z",
        "auto_renew": true
      },
      "payment": {
        "amount": "5.000000",
        "currency": "USDC",
        "tx_hash": "0x...",
        "status": "confirmed",
        "block_number": 12345678
      }
    }
    ```
  </Accordion>
  
  <Accordion title="Error Responses">
    ```json
    // Payment not found on-chain
    {
      "error": "payment_not_found",
      "message": "USDC transfer not found or insufficient amount",
      "required_amount": "5.000000",
      "found_amount": "0.000000"
    }
    
    // Payment intent expired
    {
      "error": "payment_expired",
      "message": "Payment intent expired. Please create a new upgrade request.",
      "deadline": "2026-02-01T15:30:00Z"
    }
    ```
  </Accordion>
</AccordionGroup>

### GET /api/v1/subscriptions/current

Get current subscription details and upcoming renewal information.

<AccordionGroup>
  <Accordion title="Response">
    ```json
    {
      "subscription": {
        "id": "sub_def456",
        "tier": "core",
        "status": "active",
        "starts_at": "2026-02-01T00:00:00Z",
        "renews_at": "2026-03-01T00:00:00Z",
        "auto_renew": true,
        "cancelled_at": null
      },
      "usage": {
        "storage_used": 45000000,    // 45MB
        "storage_limit": 104857600,  // 100MB
        "stacks_used": 2,
        "stack_limit": 3,
        "period": "2026-02"
      },
      "renewal": {
        "amount": "5.000000",
        "currency": "USDC",
        "can_renew": true,
        "wallet_balance": "42.500000",
        "days_until_renewal": 28
      }
    }
    ```
  </Accordion>
  
  <Accordion title="Free Tier Response">
    ```json
    {
      "subscription": {
        "tier": "free",
        "status": "active",
        "auto_renew": false
      },
      "usage": {
        "storage_used": 8500000,     // 8.5MB
        "storage_limit": 10485760,   // 10MB
        "stacks_used": 1,
        "stack_limit": 1,
        "period": "2026-02"
      },
      "upgrade_available": true
    }
    ```
  </Accordion>
</AccordionGroup>

### POST /api/v1/subscriptions/cancel

Cancel auto-renewal. Subscription remains active until the end of the current billing period.

<AccordionGroup>
  <Accordion title="Request Body">
    ```json
    {
      "reason": "No longer needed"  // Optional
    }
    ```
  </Accordion>
  
  <Accordion title="Response">
    ```json
    {
      "subscription": {
        "id": "sub_def456",
        "tier": "core",
        "status": "active",
        "auto_renew": false,
        "cancelled_at": "2026-02-01T14:30:00Z",
        "expires_at": "2026-03-01T00:00:00Z"
      },
      "message": "Auto-renewal cancelled. Subscription remains active until 2026-03-01."
    }
    ```
  </Accordion>
</AccordionGroup>

### GET /api/v1/subscriptions/usage

Detailed usage metrics for the current billing period.

<AccordionGroup>
  <Accordion title="Response">
    ```json
    {
      "period": "2026-02",
      "usage": {
        "storage": {
          "used_bytes": 45000000,
          "limit_bytes": 104857600,
          "used_mb": 45,
          "limit_mb": 100,
          "percentage": 43.0
        },
        "stacks": {
          "syncing": [
            {
              "id": "ash-primary",
              "name": "Primary Identity",
              "size_bytes": 35000000,
              "last_sync": "2026-02-01T14:15:00Z"
            },
            {
              "id": "ash-security",
              "name": "Security Work",
              "size_bytes": 10000000,
              "last_sync": "2026-02-01T13:45:00Z"
            }
          ],
          "local_only": [
            {
              "id": "ash-experimental",
              "name": "Experiments",
              "size_bytes": 2000000
            }
          ]
        },
        "sync_operations": {
          "total": 847,
          "daily_average": 28.2,
          "last_24h": 34
        }
      }
    }
    ```
  </Accordion>
</AccordionGroup>

### GET /api/v1/subscriptions/payments

Payment history for the account.

<AccordionGroup>
  <Accordion title="Query Parameters">
    - `limit` (optional): Number of payments to return (default: 50, max: 100)
    - `offset` (optional): Pagination offset (default: 0)
  </Accordion>
  
  <Accordion title="Response">
    ```json
    {
      "payments": [
        {
          "id": "pay_abc123",
          "subscription_id": "sub_def456",
          "amount": "5.000000",
          "currency": "USDC",
          "tx_hash": "0x...",
          "from_address": "0xAb3...7eF",
          "to_address": "0xKernleTreasury...",
          "status": "confirmed",
          "period_start": "2026-02-01T00:00:00Z",
          "period_end": "2026-03-01T00:00:00Z",
          "created_at": "2026-02-01T14:30:00Z",
          "confirmed_at": "2026-02-01T14:32:00Z"
        }
      ],
      "pagination": {
        "total": 3,
        "limit": 50,
        "offset": 0
      }
    }
    ```
  </Accordion>
</AccordionGroup>

## Error Codes

Standard HTTP status codes with detailed error responses:

| Code | Error | Description |
|------|-------|-------------|
| 400 | `invalid_tier` | Requested tier is invalid or not available |
| 402 | `quota_exceeded` | Storage or stack limit exceeded |
| 404 | `subscription_not_found` | No active subscription for account |
| 409 | `upgrade_in_progress` | Another upgrade is already pending |
| 429 | `rate_limited` | Too many requests |

### Error Response Format

```json
{
  "error": "quota_exceeded",
  "message": "Storage limit exceeded (45.2MB / 10MB). Upgrade to Core tier for 100MB.",
  "details": {
    "current_tier": "free",
    "usage_bytes": 47400000,
    "limit_bytes": 10485760,
    "suggested_tier": "core"
  }
}
```

## Rate Limits

| Endpoint | Rate Limit | Burst |
|----------|------------|-------|
| `/upgrade` | 5 per hour | 2 |
| `/confirm` | 10 per hour | 5 |
| `/current` | 100 per hour | 20 |
| `/usage` | 100 per hour | 20 |
| `/payments` | 50 per hour | 10 |

Rate limits are per API key. Headers indicate current usage:

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 87
X-RateLimit-Reset: 1672531200
```

## WebHooks (Future)

Optional webhook notifications for subscription events:

| Event | Description |
|-------|-------------|
| `subscription.upgraded` | Tier upgrade completed |
| `subscription.renewed` | Auto-renewal successful |
| `subscription.expired` | Subscription expired |
| `subscription.cancelled` | Auto-renewal cancelled |
| `payment.failed` | Auto-renewal payment failed |

<Note>
Webhook implementation is planned for a future release. For now, poll `/subscriptions/current` or use CLI commands for status updates.
</Note>

## Code Examples

<Tabs>
  <Tab title="Full Upgrade Flow">
    ```python
    import requests
    import time
    
    # Step 1: Initiate upgrade
    response = requests.post(
        "https://api.kernle.ai/v1/subscriptions/upgrade",
        headers={"Authorization": f"Bearer {api_key}"},
        json={"tier": "core"}
    )
    
    payment_intent = response.json()["payment_intent"]
    
    # Step 2: Send USDC payment (using your wallet SDK)
    tx_hash = send_usdc(
        to=payment_intent["treasury_address"],
        amount=payment_intent["amount"]
    )
    
    # Step 3: Wait for confirmation
    time.sleep(30)  # Wait for block confirmation
    
    # Step 4: Confirm payment
    response = requests.post(
        "https://api.kernle.ai/v1/subscriptions/confirm",
        headers={"Authorization": f"Bearer {api_key}"},
        json={
            "payment_intent_id": payment_intent["id"],
            "tx_hash": tx_hash
        }
    )
    
    subscription = response.json()["subscription"]
    print(f"Upgraded to {subscription['tier']} tier!")
    ```
  </Tab>
  
  <Tab title="Usage Monitoring">
    ```python
    def check_usage_and_warn():
        response = requests.get(
            "https://api.kernle.ai/v1/subscriptions/current",
            headers={"Authorization": f"Bearer {api_key}"}
        )
        
        data = response.json()
        usage = data["usage"]
        
        storage_pct = (usage["storage_used"] / usage["storage_limit"]) * 100
        
        if storage_pct > 90:
            print(f"⚠️  Storage {storage_pct:.1f}% full")
            print("Consider upgrading tier or cleaning old data")
        
        if "renewal" in data:
            renewal = data["renewal"]
            if not renewal["can_renew"]:
                print(f"⚠️  Insufficient USDC for auto-renewal")
                print(f"Need {renewal['amount']} USDC, have {renewal['wallet_balance']}")
    ```
  </Tab>
</Tabs>